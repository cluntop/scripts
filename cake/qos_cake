#!/bin/sh
# CAKE QoS ç®€åŒ–ç‰ˆ - ä¸“ä¸º PPPoE ä¼˜åŒ–

# é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG_FILE="/etc/config/qos_cake_simple"

# PPPoE æ¥å£æ£€æµ‹
detect_pppoe_interface() {
    # ä¼˜å…ˆæ£€æµ‹ PPPoE æ¥å£
    local pppoe_if=""
    
    if [ -d "/sys/class/net" ]; then
        for iface in /sys/class/net/*; do
            local if_name=$(basename "$iface")
            case "$if_name" in
                pppoe-wan|ppp0|wan) 
                    if ip link show "$if_name" >/dev/null 2>&1; then
                        pppoe_if="$if_name"
                        break
                    fi
                    ;;
            esac
        done
    fi
    
    # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤
    echo "${pppoe_if:-pppoe-wan}"
}

# è¯»å–é…ç½®
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        . "$CONFIG_FILE"
    else
        setup_config
    fi
    
    # éªŒè¯æ•°å€¼
    case "$UPLOAD_MBPS" in ''|*[!0-9]*) UPLOAD_MBPS=10 ;; esac
    case "$DOWNLOAD_MBPS" in ''|*[!0-9]*) DOWNLOAD_MBPS=50 ;; esac
    
    # CAKE è‡ªåŠ¨è°ƒä¼˜ï¼Œåªéœ€ 95% å¸¦å®½å³å¯
    UPLOAD_KBPS=$(( UPLOAD_MBPS * 950 ))
    DOWNLOAD_KBPS=$(( DOWNLOAD_MBPS * 950 ))
    
    # PPPoE å›ºå®šå‚æ•°
    WAN_IF="${WAN_IF:-$(detect_pppoe_interface)}"
}

# ç®€åŒ–é…ç½®å‘å¯¼
setup_config() {
    printf "\n${GREEN}ğŸ° CAKE QoS ç®€åŒ–é…ç½® (PPPoE ä¸“ç”¨)${NC}\n"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n\n"
    
    # è‡ªåŠ¨æ£€æµ‹ PPPoE æ¥å£
    WAN_IF=$(detect_pppoe_interface)
    printf "æ£€æµ‹åˆ° PPPoE æ¥å£: ${CYAN}%s${NC}\n" "$WAN_IF"
    
    # è¯¢é—®æ¥å£ç¡®è®¤
    printf "ç¡®è®¤ä½¿ç”¨æ­¤æ¥å£å—? (ç›´æ¥å›è½¦ç¡®è®¤ï¼Œæˆ–è¾“å…¥å…¶ä»–æ¥å£å): "
    read input_interface
    if [ -n "$input_interface" ]; then
        WAN_IF="$input_interface"
    fi
    
    echo ""
    
    # è¯¢é—®ä¸Šä¼ é€Ÿåº¦
    while true; do
        printf "è¯·è¾“å…¥å®é™…ä¸Šä¼ é€Ÿåº¦ (Mbps): "
        read UPLOAD_MBPS
        if echo "$UPLOAD_MBPS" | grep -q '^[0-9]\+$' && [ "$UPLOAD_MBPS" -gt 0 ]; then
            break
        else
            printf "${RED}è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—${NC}\n"
        fi
    done
    
    # è¯¢é—®ä¸‹è½½é€Ÿåº¦
    while true; do
        printf "è¯·è¾“å…¥å®é™…ä¸‹è½½é€Ÿåº¦ (Mbps): "
        read DOWNLOAD_MBPS
        if echo "$DOWNLOAD_MBPS" | grep -q '^[0-9]\+$' && [ "$DOWNLOAD_MBPS" -gt 0 ]; then
            break
        else
            printf "${RED}è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—${NC}\n"
        fi
    done
    
    # æ˜¾ç¤ºé…ç½®æ€»ç»“
    echo ""
    printf "${PURPLE}é…ç½®æ€»ç»“${NC}\n"
    printf "æ¥å£: ${CYAN}%s${NC} (PPPoE)\n" "$WAN_IF"
    printf "ä¸Šä¼ : ${YELLOW}%s Mbps${NC} -> CAKEé™é€Ÿ: ${GREEN}%s Kbps${NC}\n" "$UPLOAD_MBPS" "$((UPLOAD_MBPS * 950))"
    printf "ä¸‹è½½: ${YELLOW}%s Mbps${NC} -> CAKEé™é€Ÿ: ${GREEN}%s Kbps${NC}\n" "$DOWNLOAD_MBPS" "$((DOWNLOAD_MBPS * 950))"
    printf "ç‰¹æ€§: ${CYAN}DiffServ4 æ¸¸æˆä¼˜å…ˆçº§ + PPPoE ä¼˜åŒ–${NC}\n"
    echo ""
    
    printf "ç¡®è®¤ä¿å­˜é…ç½®? (y/n): "
    read confirm
    case "$confirm" in
        [Yy]|[Yy][Ee][Ss]|"") 
            save_config
            printf "${GREEN}âœ… é…ç½®å·²ä¿å­˜${NC}\n"
            ;;
        *)
            printf "${RED}âŒ é…ç½®å·²å–æ¶ˆ${NC}\n"
            exit 0
            ;;
    esac
}

# ä¿å­˜é…ç½®
save_config() {
    mkdir -p "$(dirname "$CONFIG_FILE")"
    cat > "$CONFIG_FILE" << EOF
# CAKE QoS ç®€åŒ–é…ç½® - PPPoE ä¸“ç”¨
# ç”Ÿæˆæ—¶é—´: $(date)

WAN_IF="$WAN_IF"
UPLOAD_MBPS=$UPLOAD_MBPS
DOWNLOAD_MBPS=$DOWNLOAD_MBPS
EOF
    chmod 644 "$CONFIG_FILE"
}

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ£€æŸ¥ CAKE æ”¯æŒ
check_cake() {
    if ! lsmod | grep -q "sch_cake" 2>/dev/null; then
        printf "${YELLOW}æ­£åœ¨åŠ è½½ CAKE æ¨¡å—...${NC}\n"
        if ! modprobe sch_cake 2>/dev/null; then
            printf "${RED}âŒ CAKE æ¨¡å—åŠ è½½å¤±è´¥${NC}\n"
            printf "è¯·ç¡®ä¿å†…æ ¸æ”¯æŒ CAKE æˆ–å®‰è£…ç›¸å…³æ¨¡å—\n"
            exit 1
        fi
    fi
    printf "${GREEN}âœ… CAKE æ”¯æŒå·²ç¡®è®¤${NC}\n"
}

# æ£€æŸ¥ç°æœ‰é…ç½®
check_existing_config() {
    local wan_if="$1"
    
    # æ£€æŸ¥æ˜¯å¦å·²ç»é…ç½®äº† CAKE
    if tc qdisc show dev "$wan_if" | grep -q "qdisc cake"; then
        printf "${YELLOW}âš ï¸  æ£€æµ‹åˆ°ç°æœ‰ CAKE é…ç½®${NC}\n"
        printf "æ˜¯å¦åœæ­¢ç°æœ‰é…ç½®å¹¶é‡æ–°é…ç½®? (y/n): "
        read confirm
        case "$confirm" in
            [Yy]|[Yy][Ee][Ss]) 
                stop_qos
                sleep 1
                ;;
            *) 
                printf "${RED}âŒ é…ç½®å·²å–æ¶ˆ${NC}\n"
                exit 0
                ;;
        esac
    fi
}

# å¯åŠ¨ CAKE QoS
start_qos() {
    load_config
    check_cake
    
    # æ£€æŸ¥æ¥å£
    if ! ip link show "$WAN_IF" >/dev/null 2>&1; then
        printf "${RED}âŒ æ¥å£ '$WAN_IF' ä¸å­˜åœ¨${NC}\n"
        printf "è¯·æ£€æŸ¥ PPPoE è¿æ¥çŠ¶æ€æˆ–é‡æ–°é…ç½®\n"
        exit 1
    fi
    
    # æ£€æŸ¥ç°æœ‰é…ç½®
    check_existing_config "$WAN_IF"
    
    printf "${GREEN}ğŸ° å¯åŠ¨ CAKE QoS (PPPoE ä¼˜åŒ–)${NC}\n"
    printf "æ¥å£: %s | ä¸Šä¼ : %s Kbps | ä¸‹è½½: %s Kbps\n" "$WAN_IF" "$UPLOAD_KBPS" "$DOWNLOAD_KBPS"
    
    # ç®€åŒ–æ¸…ç† - åªæ¸…ç†å¿…è¦çš„é…ç½®
    printf "${YELLOW}æ­£åœ¨æ¸…ç†ç°æœ‰é˜Ÿåˆ—é…ç½®...${NC}\n"
    
    # æ¸…ç†ç°æœ‰é˜Ÿåˆ—ï¼ˆå®‰é™æ¨¡å¼ï¼Œå¿½ç•¥é”™è¯¯ï¼‰
    tc qdisc del dev "$WAN_IF" root 2>/dev/null || true
    tc qdisc del dev "$WAN_IF" ingress 2>/dev/null || true
    
    # æ¸…ç†å¯èƒ½å­˜åœ¨çš„ IFB è®¾å¤‡
    if ip link show ifb0 >/dev/null 2>&1; then
        tc qdisc del dev ifb0 root 2>/dev/null || true
        ip link set dev ifb0 down 2>/dev/null || true
        ip link del ifb0 2>/dev/null || true
    fi
    
    # ä¸Šä¼ é˜Ÿåˆ— - CAKE é…ç½®
    printf "${GREEN}é…ç½®ä¸Šä¼ é˜Ÿåˆ—...${NC}\n"
    if ! tc qdisc add dev "$WAN_IF" root cake \
        bandwidth "${UPLOAD_KBPS}kbit" \
        diffserv4 \
        nat \
        ack-filter \
        overhead 18; then
        printf "${RED}âŒ ä¸Šä¼ é˜Ÿåˆ—é…ç½®å¤±è´¥${NC}\n"
        exit 1
    fi
    
    # ä¸‹è½½é˜Ÿåˆ— - ç®€åŒ– IFB è®¾ç½®
    printf "${GREEN}é…ç½®ä¸‹è½½é˜Ÿåˆ—...${NC}\n"
    
    if ! lsmod | grep -q "ifb"; then
        modprobe ifb numifbs=1 2>/dev/null || true
    fi
    
    # åˆ›å»º IFB è®¾å¤‡
    if ! ip link show ifb0 >/dev/null 2>&1; then
        if ! ip link add name ifb0 type ifb 2>/dev/null; then
            printf "${RED}âŒ æ— æ³•åˆ›å»º IFB è®¾å¤‡${NC}\n"
            exit 1
        fi
    fi
    
    if ! ip link set dev ifb0 up; then
        printf "${RED}âŒ æ— æ³•å¯åŠ¨ IFB è®¾å¤‡${NC}\n"
        exit 1
    fi
    
    # è®¾ç½®å…¥å£é‡å®šå‘
    if ! tc qdisc add dev "$WAN_IF" ingress; then
        printf "${RED}âŒ æ— æ³•æ·»åŠ å…¥å£é˜Ÿåˆ—${NC}\n"
        exit 1
    fi
    
    if ! tc filter add dev "$WAN_IF" parent ffff: protocol all u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0; then
        printf "${RED}âŒ æ— æ³•æ·»åŠ é‡å®šå‘è§„åˆ™${NC}\n"
        exit 1
    fi
    
    # é…ç½®ä¸‹è½½é˜Ÿåˆ—
    if ! tc qdisc add dev ifb0 root cake \
        bandwidth "${DOWNLOAD_KBPS}kbit" \
        diffserv4 \
        nat \
        ingress \
        overhead 18; then
        printf "${RED}âŒ ä¸‹è½½é˜Ÿåˆ—é…ç½®å¤±è´¥${NC}\n"
        exit 1
    fi
    
    printf "${GREEN}âœ… CAKE QoS å¯åŠ¨å®Œæˆ${NC}\n"
    printf "${CYAN}ğŸ® æ¸¸æˆæµé‡å°†è‡ªåŠ¨è·å¾—æœ€é«˜ä¼˜å…ˆçº§${NC}\n"
}

# åœæ­¢ QoS
stop_qos() {
    load_config
    printf "${YELLOW}æ­£åœ¨åœæ­¢ CAKE QoS...${NC}\n"
    
    # ç®€åŒ–åœæ­¢é€»è¾‘ï¼Œå¿½ç•¥æ‰€æœ‰é”™è¯¯
    tc qdisc del dev "$WAN_IF" root 2>/dev/null || true
    tc qdisc del dev "$WAN_IF" ingress 2>/dev/null || true
    
    # æ¸…ç† IFB è®¾å¤‡
    if ip link show ifb0 >/dev/null 2>&1; then
        tc qdisc del dev ifb0 root 2>/dev/null || true
        ip link set dev ifb0 down 2>/dev/null || true
        ip link del ifb0 2>/dev/null || true
    fi
    
    printf "${GREEN}âœ… CAKE QoS å·²åœæ­¢${NC}\n"
}

# å®æ—¶ç›‘æ§ CAKE é˜Ÿåˆ—
monitor_qos() {
    load_config
    
    # æ£€æŸ¥æ˜¯å¦è¿è¡Œ
    if ! tc qdisc show dev "$WAN_IF" | grep -q "qdisc cake"; then
        printf "${RED}âŒ CAKE QoS æœªè¿è¡Œ${NC}\n"
        printf "è¯·å…ˆè¿è¡Œ: $0 start\n"
        exit 1
    fi
    
    printf "${GREEN}ğŸ° CAKE QoS å®æ—¶ç›‘æ§${NC}\n"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "${YELLOW}æŒ‰ Ctrl+C é€€å‡ºç›‘æ§${NC}\n\n"
    
    # æ¸…å±å‡½æ•°
    clear_screen() {
        printf "\033[2J\033[H"
    }
    
    # æ ¼å¼åŒ–å­—èŠ‚æ•°
    format_bytes() {
        local bytes=$1
        if [ "$bytes" -gt 1073741824 ]; then
            printf "%.2f GB" $((bytes * 100 / 1073741824))e-2
        elif [ "$bytes" -gt 1048576 ]; then
            printf "%.2f MB" $((bytes * 100 / 1048576))e-2
        elif [ "$bytes" -gt 1024 ]; then
            printf "%.2f KB" $((bytes * 100 / 1024))e-2
        else
            printf "%d B" "$bytes"
        fi
    }
    
    # è·å– CAKE ç»Ÿè®¡ä¿¡æ¯
    get_cake_stats() {
        local device=$1
        local direction=$2
        local stats=$(tc -s qdisc show dev "$device" | grep -A 20 "qdisc cake")
        
        if [ -n "$stats" ]; then
            # è§£æç»Ÿè®¡ä¿¡æ¯
            local sent=$(echo "$stats" | grep "Sent" | awk '{print $2}')
            local dropped=$(echo "$stats" | grep "dropped" | awk '{print $6}' | sed 's/,//')
            local overlimits=$(echo "$stats" | grep "overlimits" | awk '{print $8}')
            local requeues=$(echo "$stats" | grep "requeues" | awk '{print $10}')
            
            printf "${CYAN}%s é˜Ÿåˆ—çŠ¶æ€:${NC}\n" "$direction"
            printf "  ğŸ“¦ å‘é€: %s å­—èŠ‚\n" "$(format_bytes ${sent:-0})"
            printf "  ğŸ—‘ï¸  ä¸¢åŒ…: %s ä¸ª\n" "${dropped:-0}"
            printf "  âš ï¸  è¶…é™: %s æ¬¡\n" "${overlimits:-0}"
            printf "  ğŸ”„ é‡æ’: %s æ¬¡\n" "${requeues:-0}"
            
            # è·å– CAKE ç‰¹æœ‰ç»Ÿè®¡
            local cake_info=$(echo "$stats" | grep -E "(memory|drops|marks|ack_drop)")
            if [ -n "$cake_info" ]; then
                printf "  ğŸ§  å†…å­˜: $(echo "$cake_info" | grep "memory" | awk '{print $2}' || echo "N/A")\n"
                printf "  ğŸš« ACKä¸¢å¼ƒ: $(echo "$cake_info" | grep "ack_drop" | awk '{print $2}' || echo "N/A")\n"
            fi
            echo
        fi
    }
    
    # è·å–æµåˆ†ç±»ä¿¡æ¯
    get_flow_stats() {
        local device=$1
        local direction=$2
        local stats=$(tc -s class show dev "$device" 2>/dev/null)
        
        if [ -n "$stats" ]; then
            printf "${CYAN}%s æµé‡åˆ†ç±»:${NC}\n" "$direction"
            
            # è§£æ DiffServ4 ç±»åˆ«
            echo "$stats" | while IFS= read -r line; do
                case "$line" in
                    *"class cake 1:1"*) printf "  ğŸ® è¯­éŸ³/æ¸¸æˆ: " ;;
                    *"class cake 1:2"*) printf "  ğŸ“¹ è§†é¢‘æµ: " ;;
                    *"class cake 1:3"*) printf "  ğŸŒ æ™®é€šæµé‡: " ;;
                    *"class cake 1:4"*) printf "  ğŸ“¦ æ‰¹é‡ä¸‹è½½: " ;;
                    *"Sent "*) 
                        local sent=$(echo "$line" | awk '{print $2}')
                        local packets=$(echo "$line" | awk '{print $4}')
                        printf "%s (%s åŒ…)\n" "$(format_bytes ${sent:-0})" "${packets:-0}"
                        ;;
                esac
            done
            echo
        fi
    }
    
    # ä¸»ç›‘æ§å¾ªç¯
    while true; do
        clear_screen
        
        # æ ‡é¢˜å’Œæ—¶é—´
        printf "${GREEN}ğŸ° CAKE QoS å®æ—¶ç›‘æ§${NC} - %s\n" "$(date '+%H:%M:%S')"
        printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
        printf "æ¥å£: ${CYAN}%s${NC} | ä¸Šä¼ é™åˆ¶: ${YELLOW}%s Kbps${NC} | ä¸‹è½½é™åˆ¶: ${YELLOW}%s Kbps${NC}\n\n" \
               "$WAN_IF" "$UPLOAD_KBPS" "$DOWNLOAD_KBPS"
        
        # ä¸Šä¼ ç»Ÿè®¡
        get_cake_stats "$WAN_IF" "ä¸Šä¼ "
        get_flow_stats "$WAN_IF" "ä¸Šä¼ "
        
        # ä¸‹è½½ç»Ÿè®¡ï¼ˆå¦‚æœ IFB å­˜åœ¨ï¼‰
        if ip link show ifb0 >/dev/null 2>&1; then
            get_cake_stats "ifb0" "ä¸‹è½½"
            get_flow_stats "ifb0" "ä¸‹è½½"
        fi
        
        # ç½‘ç»œå»¶è¿Ÿæµ‹è¯•
        printf "${CYAN}ç½‘ç»œå»¶è¿Ÿæµ‹è¯•:${NC}\n"
        if command -v ping >/dev/null 2>&1; then
            local ping_result=$(ping -c 1 -W 1 8.8.8.8 2>/dev/null | grep "time=" | awk -F'time=' '{print $2}' | awk '{print $1}')
            if [ -n "$ping_result" ]; then
                printf "  ğŸŒ å»¶è¿Ÿ: %s ms\n" "$ping_result"
            else
                printf "  ğŸŒ å»¶è¿Ÿ: æµ‹è¯•å¤±è´¥\n"
            fi
        else
            printf "  ğŸŒ å»¶è¿Ÿ: ping å‘½ä»¤ä¸å¯ç”¨\n"
        fi
        echo
        
        # ç³»ç»Ÿè´Ÿè½½
        if [ -f "/proc/loadavg" ]; then
            local load=$(cat /proc/loadavg | awk '{print $1}')
            printf "${CYAN}ç³»ç»ŸçŠ¶æ€:${NC}\n"
            printf "  ğŸ’» è´Ÿè½½: %s\n" "$load"
        fi
        
        printf "\n${YELLOW}âš¡ åˆ·æ–°é—´éš”: 2ç§’ | æŒ‰ Ctrl+C é€€å‡º${NC}\n"
        
        sleep 2
    done
}

# æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
show_detailed_stats() {
    load_config
    
    printf "${GREEN}ğŸ° CAKE QoS è¯¦ç»†ç»Ÿè®¡${NC}\n"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n\n"
    
    # æ£€æŸ¥æ˜¯å¦è¿è¡Œ
    if ! tc qdisc show dev "$WAN_IF" | grep -q "qdisc cake"; then
        printf "${RED}âŒ CAKE QoS æœªè¿è¡Œ${NC}\n"
        return 1
    fi
    
    printf "${CYAN}ğŸ“Š ä¸Šä¼ é˜Ÿåˆ—è¯¦ç»†ä¿¡æ¯:${NC}\n"
    tc -s -d qdisc show dev "$WAN_IF"
    echo
    
    printf "${CYAN}ğŸ“Š ä¸Šä¼ é˜Ÿåˆ—ç±»åˆ«ç»Ÿè®¡:${NC}\n"
    tc -s class show dev "$WAN_IF" 2>/dev/null || printf "æ— ç±»åˆ«ä¿¡æ¯\n"
    echo
    
    if ip link show ifb0 >/dev/null 2>&1; then
        printf "${CYAN}ğŸ“Š ä¸‹è½½é˜Ÿåˆ—è¯¦ç»†ä¿¡æ¯:${NC}\n"
        tc -s -d qdisc show dev ifb0
        echo
        
        printf "${CYAN}ğŸ“Š ä¸‹è½½é˜Ÿåˆ—ç±»åˆ«ç»Ÿè®¡:${NC}\n"
        tc -s class show dev ifb0 2>/dev/null || printf "æ— ç±»åˆ«ä¿¡æ¯\n"
        echo
    fi
}

# é‡ç½®ç»Ÿè®¡æ•°æ®
reset_stats() {
    load_config
    
    printf "${YELLOW}æ­£åœ¨é‡ç½® CAKE ç»Ÿè®¡æ•°æ®...${NC}\n"
    
    # é‡å¯é˜Ÿåˆ—ä»¥é‡ç½®ç»Ÿè®¡
    if tc qdisc show dev "$WAN_IF" | grep -q "qdisc cake"; then
        printf "é‡ç½®ä¸Šä¼ é˜Ÿåˆ—ç»Ÿè®¡...\n"
        tc qdisc replace dev "$WAN_IF" root cake \
            bandwidth "${UPLOAD_KBPS}kbit" \
            diffserv4 \
            nat \
            ack-filter \
            overhead 18
    fi
    
    if ip link show ifb0 >/dev/null 2>&1; then
        printf "é‡ç½®ä¸‹è½½é˜Ÿåˆ—ç»Ÿè®¡...\n"
        tc qdisc replace dev ifb0 root cake \
            bandwidth "${DOWNLOAD_KBPS}kbit" \
            diffserv4 \
            nat \
            ingress \
            overhead 18
    fi
    
    printf "${GREEN}âœ… ç»Ÿè®¡æ•°æ®å·²é‡ç½®${NC}\n"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    load_config
    
    printf "${GREEN}ğŸ° CAKE QoS çŠ¶æ€${NC}\n"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    # æ£€æŸ¥æ˜¯å¦è¿è¡Œ
    if tc qdisc show dev "$WAN_IF" | grep -q "qdisc cake"; then
        printf "çŠ¶æ€: ${GREEN}è¿è¡Œä¸­${NC}\n"
        
        # æ˜¾ç¤ºç»Ÿè®¡
        printf "\n${CYAN}ä¸Šä¼ é˜Ÿåˆ—ç»Ÿè®¡:${NC}\n"
        tc -s qdisc show dev "$WAN_IF" | grep -A 8 "qdisc cake"
        
        if ip link show ifb0 >/dev/null 2>&1; then
            printf "\n${CYAN}ä¸‹è½½é˜Ÿåˆ—ç»Ÿè®¡:${NC}\n"
            tc -s qdisc show dev ifb0 | grep -A 8 "qdisc cake"
        fi
    else
        printf "çŠ¶æ€: ${RED}æœªè¿è¡Œ${NC}\n"
    fi
    
    printf "\n${CYAN}å½“å‰é…ç½®:${NC}\n"
    printf "æ¥å£: %s (PPPoE)\n" "$WAN_IF"
    printf "ä¸Šä¼ : %s Mbps (%s Kbps)\n" "$UPLOAD_MBPS" "$UPLOAD_KBPS"
    printf "ä¸‹è½½: %s Mbps (%s Kbps)\n" "$DOWNLOAD_MBPS" "$DOWNLOAD_KBPS"
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    printf "${GREEN}ğŸ° CAKE QoS ç®€åŒ–ç‰ˆ - PPPoE ä¸“ç”¨${NC}\n"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n\n"
    
    printf "${CYAN}å‘½ä»¤:${NC}\n"
    printf "  start       - å¯åŠ¨ CAKE QoS\n"
    printf "  stop        - åœæ­¢ CAKE QoS\n"
    printf "  restart     - é‡å¯ CAKE QoS\n"
    printf "  status      - æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€\n"
    printf "  monitor     - å®æ—¶ç›‘æ§ç•Œé¢\n"
    printf "  stats       - æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡\n"
    printf "  reset       - é‡ç½®ç»Ÿè®¡æ•°æ®\n"
    printf "  config      - é‡æ–°é…ç½®\n"
    printf "  help        - æ˜¾ç¤ºå¸®åŠ©\n\n"
    
    printf "${CYAN}ç‰¹æ€§:${NC}\n"
    printf "  âœ… ä¸“ä¸º PPPoE è¿æ¥ä¼˜åŒ–\n"
    printf "  âœ… CAKE ç®—æ³•è‡ªåŠ¨è°ƒä¼˜\n"
    printf "  âœ… DiffServ4 æ¸¸æˆä¼˜å…ˆçº§\n"
    printf "  âœ… æ™ºèƒ½ ACK è¿‡æ»¤\n"
    printf "  âœ… è‡ªåŠ¨ NAT æ£€æµ‹\n\n"
    
    printf "${CYAN}ä½¿ç”¨æ–¹æ³•:${NC}\n"
    printf "  1. è¿è¡Œ './qos_cake_simple start' è¿›è¡Œé…ç½®\n"
    printf "  2. è¾“å…¥ PPPoE æ¥å£å’Œå®é™…å¸¦å®½\n"
    printf "  3. CAKE ä¼šè‡ªåŠ¨å¤„ç†å…¶ä»–æ‰€æœ‰å‚æ•°\n"
}

# ä¸»ç¨‹åº
case "$1" in
    "start")
        start_qos
        ;;
    "stop")
        stop_qos
        ;;
    "restart")
        stop_qos
        sleep 1
        start_qos
        ;;
    "status")
        show_status
        ;;
    "monitor")
        monitor_qos
        ;;
    "stats")
        show_detailed_stats
        ;;
    "reset")
        reset_stats
        ;;
    "config")
        setup_config
        ;;
    "help"|"-h"|"--help"|"")
        show_help
        ;;
    *)
        printf "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}\n"
        printf "ä½¿ç”¨ '$0 help' æŸ¥çœ‹å¸®åŠ©\n"
        exit 1
        ;;
esac
