#!/bin/sh
# CAKE QoS ç®€åŒ–ç‰ˆ - ä¸“ä¸º PPPoE ä¼˜åŒ–

# é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG_FILE="/etc/config/qos_cake_simple"

# PPPoE æ¥å£æ£€æµ‹
detect_pppoe_interface() {
    # ä¼˜å…ˆæ£€æµ‹ PPPoE æ¥å£
    local pppoe_if=""
    
    if [ -d "/sys/class/net" ]; then
        for iface in /sys/class/net/*; do
            local if_name=$(basename "$iface")
            case "$if_name" in
                pppoe-wan|ppp0|wan) 
                    if ip link show "$if_name" >/dev/null 2>&1; then
                        pppoe_if="$if_name"
                        break
                    fi
                    ;;
            esac
        done
    fi
    
    # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤
    echo "${pppoe_if:-pppoe-wan}"
}

# è¯»å–é…ç½®
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        . "$CONFIG_FILE"
    else
        setup_config
    fi
    
    # éªŒè¯æ•°å€¼
    case "$UPLOAD_MBPS" in ''|*[!0-9]*) UPLOAD_MBPS=10 ;; esac
    case "$DOWNLOAD_MBPS" in ''|*[!0-9]*) DOWNLOAD_MBPS=50 ;; esac
    
    # CAKE è‡ªåŠ¨è°ƒä¼˜ï¼Œåªéœ€ 95% å¸¦å®½å³å¯
    UPLOAD_KBPS=$(( UPLOAD_MBPS * 950 ))
    DOWNLOAD_KBPS=$(( DOWNLOAD_MBPS * 950 ))
    
    # PPPoE å›ºå®šå‚æ•°
    WAN_IF="${WAN_IF:-$(detect_pppoe_interface)}"
}

# ç®€åŒ–é…ç½®å‘å¯¼
setup_config() {
    printf "\n${GREEN}ğŸ° CAKE QoS ç®€åŒ–é…ç½® (PPPoE ä¸“ç”¨)${NC}\n"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n\n"
    
    # è‡ªåŠ¨æ£€æµ‹ PPPoE æ¥å£
    WAN_IF=$(detect_pppoe_interface)
    printf "æ£€æµ‹åˆ° PPPoE æ¥å£: ${CYAN}%s${NC}\n" "$WAN_IF"
    
    # è¯¢é—®æ¥å£ç¡®è®¤
    printf "ç¡®è®¤ä½¿ç”¨æ­¤æ¥å£å—? (ç›´æ¥å›è½¦ç¡®è®¤ï¼Œæˆ–è¾“å…¥å…¶ä»–æ¥å£å): "
    read input_interface
    if [ -n "$input_interface" ]; then
        WAN_IF="$input_interface"
    fi
    
    echo ""
    
    # è¯¢é—®ä¸Šä¼ é€Ÿåº¦
    while true; do
        printf "è¯·è¾“å…¥å®é™…ä¸Šä¼ é€Ÿåº¦ (Mbps): "
        read UPLOAD_MBPS
        if echo "$UPLOAD_MBPS" | grep -q '^[0-9]\+$' && [ "$UPLOAD_MBPS" -gt 0 ]; then
            break
        else
            printf "${RED}è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—${NC}\n"
        fi
    done
    
    # è¯¢é—®ä¸‹è½½é€Ÿåº¦
    while true; do
        printf "è¯·è¾“å…¥å®é™…ä¸‹è½½é€Ÿåº¦ (Mbps): "
        read DOWNLOAD_MBPS
        if echo "$DOWNLOAD_MBPS" | grep -q '^[0-9]\+$' && [ "$DOWNLOAD_MBPS" -gt 0 ]; then
            break
        else
            printf "${RED}è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—${NC}\n"
        fi
    done
    
    # æ˜¾ç¤ºé…ç½®æ€»ç»“
    echo ""
    printf "${PURPLE}é…ç½®æ€»ç»“${NC}\n"
    printf "æ¥å£: ${CYAN}%s${NC} (PPPoE)\n" "$WAN_IF"
    printf "ä¸Šä¼ : ${YELLOW}%s Mbps${NC} -> CAKEé™é€Ÿ: ${GREEN}%s Kbps${NC}\n" "$UPLOAD_MBPS" "$((UPLOAD_MBPS * 950))"
    printf "ä¸‹è½½: ${YELLOW}%s Mbps${NC} -> CAKEé™é€Ÿ: ${GREEN}%s Kbps${NC}\n" "$DOWNLOAD_MBPS" "$((DOWNLOAD_MBPS * 950))"
    printf "ç‰¹æ€§: ${CYAN}DiffServ4 æ¸¸æˆä¼˜å…ˆçº§ + PPPoE ä¼˜åŒ–${NC}\n"
    echo ""
    
    printf "ç¡®è®¤ä¿å­˜é…ç½®? (y/n): "
    read confirm
    case "$confirm" in
        [Yy]|[Yy][Ee][Ss]|"") 
            save_config
            printf "${GREEN}âœ… é…ç½®å·²ä¿å­˜${NC}\n"
            ;;
        *)
            printf "${RED}âŒ é…ç½®å·²å–æ¶ˆ${NC}\n"
            exit 0
            ;;
    esac
}

# ä¿å­˜é…ç½®
save_config() {
    mkdir -p "$(dirname "$CONFIG_FILE")"
    cat > "$CONFIG_FILE" << EOF
# CAKE QoS ç®€åŒ–é…ç½® - PPPoE ä¸“ç”¨
# ç”Ÿæˆæ—¶é—´: $(date)

WAN_IF="$WAN_IF"
UPLOAD_MBPS=$UPLOAD_MBPS
DOWNLOAD_MBPS=$DOWNLOAD_MBPS
EOF
    chmod 644 "$CONFIG_FILE"
}

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# æ£€æŸ¥ CAKE æ”¯æŒ
check_cake() {
    if ! lsmod | grep -q "sch_cake" 2>/dev/null; then
        printf "${YELLOW}æ­£åœ¨åŠ è½½ CAKE æ¨¡å—...${NC}\n"
        if ! modprobe sch_cake 2>/dev/null; then
            printf "${RED}âŒ CAKE æ¨¡å—åŠ è½½å¤±è´¥${NC}\n"
            printf "è¯·ç¡®ä¿å†…æ ¸æ”¯æŒ CAKE æˆ–å®‰è£…ç›¸å…³æ¨¡å—\n"
            exit 1
        fi
    fi
    printf "${GREEN}âœ… CAKE æ”¯æŒå·²ç¡®è®¤${NC}\n"
}

# å¯åŠ¨ CAKE QoS
start_qos() {
    load_config
    check_cake
    
    # æ£€æŸ¥æ¥å£
    if ! ip link show "$WAN_IF" >/dev/null 2>&1; then
        printf "${RED}âŒ æ¥å£ '$WAN_IF' ä¸å­˜åœ¨${NC}\n"
        printf "è¯·æ£€æŸ¥ PPPoE è¿æ¥çŠ¶æ€æˆ–é‡æ–°é…ç½®\n"
        exit 1
    fi
    
    printf "${GREEN}ğŸ° å¯åŠ¨ CAKE QoS (PPPoE ä¼˜åŒ–)${NC}\n"
    printf "æ¥å£: %s | ä¸Šä¼ : %s Kbps | ä¸‹è½½: %s Kbps\n" "$WAN_IF" "$UPLOAD_KBPS" "$DOWNLOAD_KBPS"
    
    # æ¸…ç†ç°æœ‰é…ç½®
    tc qdisc del dev "$WAN_IF" root 2>/dev/null
    tc qdisc del dev "$WAN_IF" ingress 2>/dev/null
    tc qdisc del dev ifb0 root 2>/dev/null
    ip link del ifb0 2>/dev/null
    
    # ä¸Šä¼ é˜Ÿåˆ— - CAKE è‡ªåŠ¨è°ƒä¼˜ï¼Œåªéœ€æ ¸å¿ƒå‚æ•°
    tc qdisc add dev "$WAN_IF" root cake \
        bandwidth "${UPLOAD_KBPS}kbit" \
        diffserv4 \
        nat \
        ack-filter \
        overhead 18
    
    # ä¸‹è½½é˜Ÿåˆ— - ä½¿ç”¨ IFB
    modprobe ifb
    ip link add name ifb0 type ifb 2>/dev/null
    ip link set dev ifb0 up
    tc qdisc add dev "$WAN_IF" ingress
    tc filter add dev "$WAN_IF" parent ffff: protocol all u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0
    
    tc qdisc add dev ifb0 root cake \
        bandwidth "${DOWNLOAD_KBPS}kbit" \
        diffserv4 \
        nat \
        ingress \
        overhead 18
    
    printf "${GREEN}âœ… CAKE QoS å¯åŠ¨å®Œæˆ${NC}\n"
    printf "${CYAN}ğŸ® æ¸¸æˆæµé‡å°†è‡ªåŠ¨è·å¾—æœ€é«˜ä¼˜å…ˆçº§${NC}\n"
}

# åœæ­¢ QoS
stop_qos() {
    load_config
    printf "${YELLOW}æ­£åœ¨åœæ­¢ CAKE QoS...${NC}\n"
    
    tc qdisc del dev "$WAN_IF" root 2>/dev/null
    tc qdisc del dev "$WAN_IF" ingress 2>/dev/null
    tc qdisc del dev ifb0 root 2>/dev/null
    ip link del ifb0 2>/dev/null
    
    printf "${GREEN}âœ… CAKE QoS å·²åœæ­¢${NC}\n"
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    load_config
    
    printf "${GREEN}ğŸ° CAKE QoS çŠ¶æ€${NC}\n"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    # æ£€æŸ¥æ˜¯å¦è¿è¡Œ
    if tc qdisc show dev "$WAN_IF" | grep -q "qdisc cake"; then
        printf "çŠ¶æ€: ${GREEN}è¿è¡Œä¸­${NC}\n"
        
        # æ˜¾ç¤ºç»Ÿè®¡
        printf "\n${CYAN}ä¸Šä¼ é˜Ÿåˆ—ç»Ÿè®¡:${NC}\n"
        tc -s qdisc show dev "$WAN_IF" | grep -A 8 "qdisc cake"
        
        if ip link show ifb0 >/dev/null 2>&1; then
            printf "\n${CYAN}ä¸‹è½½é˜Ÿåˆ—ç»Ÿè®¡:${NC}\n"
            tc -s qdisc show dev ifb0 | grep -A 8 "qdisc cake"
        fi
    else
        printf "çŠ¶æ€: ${RED}æœªè¿è¡Œ${NC}\n"
    fi
    
    printf "\n${CYAN}å½“å‰é…ç½®:${NC}\n"
    printf "æ¥å£: %s (PPPoE)\n" "$WAN_IF"
    printf "ä¸Šä¼ : %s Mbps (%s Kbps)\n" "$UPLOAD_MBPS" "$UPLOAD_KBPS"
    printf "ä¸‹è½½: %s Mbps (%s Kbps)\n" "$DOWNLOAD_MBPS" "$DOWNLOAD_KBPS"
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    printf "${GREEN}ğŸ° CAKE QoS ç®€åŒ–ç‰ˆ - PPPoE ä¸“ç”¨${NC}\n"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n\n"
    
    printf "${CYAN}å‘½ä»¤:${NC}\n"
    printf "  start    - å¯åŠ¨ CAKE QoS\n"
    printf "  stop     - åœæ­¢ CAKE QoS\n"
    printf "  restart  - é‡å¯ CAKE QoS\n"
    printf "  status   - æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€\n"
    printf "  config   - é‡æ–°é…ç½®\n"
    printf "  help     - æ˜¾ç¤ºå¸®åŠ©\n\n"
    
    printf "${CYAN}ç‰¹æ€§:${NC}\n"
    printf "  âœ… ä¸“ä¸º PPPoE è¿æ¥ä¼˜åŒ–\n"
    printf "  âœ… CAKE ç®—æ³•è‡ªåŠ¨è°ƒä¼˜\n"
    printf "  âœ… DiffServ4 æ¸¸æˆä¼˜å…ˆçº§\n"
    printf "  âœ… æ™ºèƒ½ ACK è¿‡æ»¤\n"
    printf "  âœ… è‡ªåŠ¨ NAT æ£€æµ‹\n\n"
    
    printf "${CYAN}ä½¿ç”¨æ–¹æ³•:${NC}\n"
    printf "  1. è¿è¡Œ './qos_cake_simple start' è¿›è¡Œé…ç½®\n"
    printf "  2. è¾“å…¥ PPPoE æ¥å£å’Œå®é™…å¸¦å®½\n"
    printf "  3. CAKE ä¼šè‡ªåŠ¨å¤„ç†å…¶ä»–æ‰€æœ‰å‚æ•°\n"
}

# ä¸»ç¨‹åº
case "$1" in
    "start")
        start_qos
        ;;
    "stop")
        stop_qos
        ;;
    "restart")
        stop_qos
        sleep 1
        start_qos
        ;;
    "status")
        show_status
        ;;
    "config")
        setup_config
        ;;
    "help"|"-h"|"--help"|"")
        show_help
        ;;
    *)
        printf "${RED}æœªçŸ¥å‘½ä»¤: $1${NC}\n"
        printf "ä½¿ç”¨ '$0 help' æŸ¥çœ‹å¸®åŠ©\n"
        exit 1
        ;;
esac
