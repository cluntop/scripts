#!/bin/sh
# QoS(fq_codel) æµé‡æ§åˆ¶è„šæœ¬

# é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG_FILE="/etc/config/qos"

# é»˜è®¤æ¥å£
WAN_IF="eth1"

# è¯»å–é…ç½®æ–‡ä»¶
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        . "$CONFIG_FILE"
    else
        # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯¢é—®ç”¨æˆ·è¾“å…¥
        setup_config
    fi
    
    # è®¡ç®—å®é™…é™é€Ÿå€¼ - fq_codel èƒ½å¾ˆå¥½å¤„ç†ç¼“å†²åŒºè†¨èƒ€ï¼Œå¯ä»¥è®¾ç½®æ›´æ¥è¿‘å®é™…é€Ÿåº¦
    UPLOAD_KBPS=$((UPLOAD_MBPS * 900))
    DOWNLOAD_KBPS=$((DOWNLOAD_MBPS * 950))
}

# åˆå§‹é…ç½®è®¾ç½®
setup_config() {
    print_header "QoS åˆå§‹é…ç½®å‘å¯¼"
    
    print_section "å½“å‰ç³»ç»Ÿå¯ç”¨çš„ç½‘ç»œæ¥å£"
    detect_interfaces
    echo ""
    
    # è¯¢é—®ç½‘ç»œæ¥å£
    while true; do
        printf "è¯·è¾“å…¥WANæ¥å£åç§° (é»˜è®¤: eth1): "
        read input_interface
        
        if [ -z "$input_interface" ]; then
            WAN_IF="eth1"
            break
        elif validate_interface "$input_interface"; then
            WAN_IF="$input_interface"
            break
        else
            print_status "error" "è¯·è¾“å…¥æœ‰æ•ˆçš„æ¥å£åç§°"
        fi
    done
    
    echo ""
    print_section "ç½‘ç»œå†…æ ¸ä¼˜åŒ–æ¨è"
    print_status "info" "å¯ç”¨ BBR æ‹¥å¡æ§åˆ¶ç®—æ³•"
    print_status "info" "ä¼˜åŒ– TCP ç¼“å†²åŒºå¤§å°"
    print_status "info" "å‡å°‘ç½‘ç»œå»¶è¿Ÿå’ŒæŠ–åŠ¨"
    print_status "info" "æå‡æ¸¸æˆè¿æ¥ç¨³å®šæ€§"
    echo ""
    
    # è¯¢é—®æ˜¯å¦åº”ç”¨sysctlä¼˜åŒ–
    if ask_yes_no "æ˜¯å¦åº”ç”¨æ¨èçš„ç½‘ç»œå†…æ ¸ä¼˜åŒ–å‚æ•°?" "y"; then
        APPLY_SYSCTL="yes"
    else
        APPLY_SYSCTL="no"
    fi
    
    echo ""
    print_section "ç½‘ç»œé€Ÿåº¦é…ç½®"
    
    # è¯¢é—®ä¸Šä¼ é€Ÿåº¦
    while true; do
        printf "è¯·è¾“å…¥å®é™…ä¸Šä¼ é€Ÿåº¦ (å•ä½: Mbps): "
        read UPLOAD_MBPS
        
        if validate_number "$UPLOAD_MBPS"; then
            break
        else
            print_status "error" "è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (å¤§äº0)"
        fi
    done
    
    # è¯¢é—®ä¸‹è½½é€Ÿåº¦
    while true; do
        printf "è¯·è¾“å…¥å®é™…ä¸‹è½½é€Ÿåº¦ (å•ä½: Mbps): "
        read DOWNLOAD_MBPS
        
        if validate_number "$DOWNLOAD_MBPS"; then
            break
        else
            print_status "error" "è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— (å¤§äº0)"
        fi
    done
    
    # ç¡®è®¤é…ç½®
    echo ""
    print_section "é…ç½®ç¡®è®¤"
    printf "  ç½‘ç»œæ¥å£: ${CYAN}%s${NC}\n" "$WAN_IF"
    printf "  ä¸Šä¼ é€Ÿåº¦: ${CYAN}%s Mbps${NC}\n" "$UPLOAD_MBPS"
    printf "  ä¸‹è½½é€Ÿåº¦: ${CYAN}%s Mbps${NC}\n" "$DOWNLOAD_MBPS"
    printf "  QoSé™é€Ÿ: ä¸Šä¼  ${YELLOW}%s Kbps${NC} / ä¸‹è½½ ${YELLOW}%s Kbps${NC}\n" "$((UPLOAD_MBPS * 900))" "$((DOWNLOAD_MBPS * 950))"
    
    if [ "$APPLY_SYSCTL" = "yes" ]; then
        print_status "success" "å°†åº”ç”¨æ¨èçš„å†…æ ¸ä¼˜åŒ–å‚æ•°"
    else
        print_status "warning" "è·³è¿‡å†…æ ¸ä¼˜åŒ–å‚æ•°"
    fi
    echo ""
    
    if ask_yes_no "ç¡®è®¤ä¿å­˜æ­¤é…ç½®?"; then
        save_config
        print_status "success" "é…ç½®å·²ä¿å­˜åˆ° $CONFIG_FILE"
        
        if [ "$APPLY_SYSCTL" = "yes" ]; then
            apply_sysctl_optimizations
        fi
    else
        print_status "error" "é…ç½®å·²å–æ¶ˆï¼Œè¯·é‡æ–°è¿è¡Œè„šæœ¬"
        exit 0
    fi
}

# ä¿å­˜é…ç½®åˆ°æ–‡ä»¶
save_config() {
    # ç¡®ä¿ç›®å½•å­˜åœ¨
    mkdir -p "$(dirname "$CONFIG_FILE")"
    
    # å†™å…¥é…ç½®æ–‡ä»¶
    cat > "$CONFIG_FILE" << EOF
# QoS é…ç½®æ–‡ä»¶
# ç”± qos è„šæœ¬è‡ªåŠ¨ç”Ÿæˆäº $(date)

# ç½‘ç»œæ¥å£
WAN_IF="$WAN_IF"

# å®é™…ç½‘ç»œé€Ÿåº¦ (Mbps)
UPLOAD_MBPS=$UPLOAD_MBPS
DOWNLOAD_MBPS=$DOWNLOAD_MBPS

# sysctlä¼˜åŒ–é€‰é¡¹
APPLY_SYSCTL="$APPLY_SYSCTL"

# é…ç½®åˆ›å»ºæ—¶é—´
CONFIG_CREATED="$(date)"
EOF
    
    chmod 644 "$CONFIG_FILE"
}

# åº”ç”¨sysctlç½‘ç»œä¼˜åŒ–å‚æ•°
apply_sysctl_optimizations() {
    echo ""
    print_status "info" "æ­£åœ¨åº”ç”¨ç½‘ç»œå†…æ ¸ä¼˜åŒ–å‚æ•°..."
    
    # å¤‡ä»½å¹¶æ¸…ç†ç°æœ‰sysctlé…ç½®
    if [ -f "/etc/sysctl.conf" ]; then
        backup_file="/etc/sysctl.conf.bak.$(date +%Y%m%d_%H%M%S)"
        print_status "info" "å¤‡ä»½ç°æœ‰ /etc/sysctl.conf åˆ° $backup_file"
        cp /etc/sysctl.conf "$backup_file" 2>/dev/null
        rm -f /etc/sysctl.conf
    fi
    
    if [ -d "/etc/sysctl.d" ]; then
        if ls /etc/sysctl.d/*.conf >/dev/null 2>&1; then
            backup_dir="/tmp/sysctl.d.bak.$(date +%Y%m%d_%H%M%S)"
            print_status "info" "å¤‡ä»½ç°æœ‰é…ç½®åˆ° $backup_dir"
            mkdir -p "$backup_dir"
            cp /etc/sysctl.d/*.conf "$backup_dir/" 2>/dev/null
        fi
        rm -rf /etc/sysctl.d
        mkdir -p /etc/sysctl.d
    else
        mkdir -p /etc/sysctl.d
    fi
    
    # åˆ›å»ºä¼˜åŒ–çš„sysctlé…ç½®
    cat > /etc/sysctl.d/99-qos-optimizations.conf << 'EOF'
# é»˜è®¤é˜Ÿåˆ—ç®—æ³•å’Œæ‹¥å¡æ§åˆ¶
net.core.default_qdisc = fq_codel
net.ipv4.tcp_congestion_control = bbr

# TCPç¼“å†²åŒºä¼˜åŒ– - æ¸¸æˆä½å»¶è¿Ÿ
net.ipv4.tcp_rmem = 8192 131072 16777216
net.ipv4.tcp_wmem = 4096 65535 16777216
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

# TCPçª—å£ä¼˜åŒ–
net.ipv4.tcp_shrink_window = 1
net.ipv4.tcp_adv_win_scale = 1

# ç«¯å£èŒƒå›´å’Œè¿æ¥ä¼˜åŒ–
net.ipv4.ip_local_port_range = 1024 65535
net.core.somaxconn = 4096
net.core.netdev_max_backlog = 4096
net.ipv4.tcp_max_tw_buckets = 32768

# TCPè¿æ¥è¡Œä¸ºä¼˜åŒ–
net.ipv4.tcp_abort_on_overflow = 1
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_syncookies = 1

# SYNå¤„ç†ä¼˜åŒ–
net.ipv4.tcp_syn_retries = 3
net.ipv4.tcp_synack_retries = 3
net.ipv4.tcp_max_syn_backlog = 4096

# è¿æ¥è¶…æ—¶ä¼˜åŒ–
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_intvl = 3
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_time = 600

# é‡ä¼ å’Œé”™è¯¯æ¢å¤
net.ipv4.tcp_retries1 = 3
net.ipv4.tcp_retries2 = 5
net.ipv4.tcp_frto = 2
net.ipv4.tcp_no_metrics_save = 1

# è½¬å‘å’ŒBBRè°ƒæ•´
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
net.ipv4.tcp_pacing_ca_ratio = 110

# æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–
fs.file-max = 104857600
fs.inotify.max_user_instances = 8192
fs.nr_open = 1048576
EOF
    
    # åº”ç”¨é…ç½®
    print_status "info" "åº”ç”¨sysctlé…ç½®..."
    sysctl -p /etc/sysctl.d/99-qos-optimizations.conf >/dev/null 2>&1
    
    # éªŒè¯å…³é”®å‚æ•°
    echo ""
    print_section "éªŒè¯å…³é”®ä¼˜åŒ–å‚æ•°"
    
    # æ£€æŸ¥BBR
    current_cc=$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null)
    if [ "$current_cc" = "bbr" ]; then
        print_status "success" "BBRæ‹¥å¡æ§åˆ¶å·²å¯ç”¨"
    else
        print_status "warning" "BBRæ‹¥å¡æ§åˆ¶å¯èƒ½éœ€è¦å†…æ ¸æ”¯æŒ"
    fi
    
    # æ£€æŸ¥fq_codel
    current_qdisc=$(sysctl -n net.core.default_qdisc 2>/dev/null)
    if [ "$current_qdisc" = "fq_codel" ]; then
        print_status "success" "fq_codelé˜Ÿåˆ—å·²å¯ç”¨"
    else
        print_status "warning" "fq_codelé˜Ÿåˆ—è®¾ç½®å®Œæˆ"
    fi
    
    # æ£€æŸ¥è½¬å‘
    ipv4_forward=$(sysctl -n net.ipv4.ip_forward 2>/dev/null)
    if [ "$ipv4_forward" = "1" ]; then
        print_status "success" "IPv4è½¬å‘å·²å¯ç”¨"
    else
        print_status "warning" "IPv4è½¬å‘éœ€è¦æ‰‹åŠ¨å¯ç”¨"
    fi
    
    echo ""
    print_status "success" "ç½‘ç»œä¼˜åŒ–å‚æ•°å·²åº”ç”¨åˆ° /etc/sysctl.d/99-qos-optimizations.conf"
    print_status "info" "å‚æ•°å°†åœ¨ä¸‹æ¬¡é‡å¯åæ°¸ä¹…ç”Ÿæ•ˆ"
}

# é¢œè‰²å’ŒUIå®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# UIè¾…åŠ©å‡½æ•°
print_header() {
    printf "${GREEN}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}\n"
    printf "${GREEN}${BOLD}â•‘ %-60s â•‘${NC}\n" "$1"
    printf "${GREEN}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    echo ""
}

print_section() {
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "${PURPLE}  %s${NC}\n" "$1"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

print_status() {
    local status=$1
    local message=$2
    case "$status" in
        "success") printf "  ${GREEN}âœ… %s${NC}\n" "$message" ;;
        "warning") printf "  ${YELLOW}âš ï¸  %s${NC}\n" "$message" ;;
        "error")   printf "  ${RED}âŒ %s${NC}\n" "$message" ;;
        "info")    printf "  ${PURPLE}â„¹ï¸  %s${NC}\n" "$message" ;;
    esac
}

# ç»Ÿä¸€çš„æ¥å£æ£€æµ‹å‡½æ•°
detect_interfaces() {
    if command -v ip >/dev/null 2>&1; then
        ip link show | grep -E "^[0-9]+:" | awk -F': ' '{print "  " $2}' | sed 's/@.*//'
    elif [ -d "/sys/class/net" ]; then
        for iface in /sys/class/net/*; do
            echo "  $(basename "$iface")"
        done
    else
        echo "  æ— æ³•è‡ªåŠ¨æ£€æµ‹ï¼Œå¸¸è§æ¥å£å: eth0, eth1, wan, pppoe-wan"
    fi
}

# è¾“å…¥éªŒè¯å‡½æ•°
validate_number() {
    local input=$1
    local min=${2:-1}
    echo "$input" | grep -q '^[0-9]\+$' && [ "$input" -ge "$min" ]
}

validate_interface() {
    local interface=$1
    echo "$interface" | grep -q '^[a-zA-Z][a-zA-Z0-9-]*[0-9]*$'
}

# ç”¨æˆ·ç¡®è®¤å‡½æ•°
ask_yes_no() {
    local question=$1
    local default=${2:-""}
    
    while true; do
        if [ -n "$default" ]; then
            printf "%s (y/n, é»˜è®¤: %s): " "$question" "$default"
        else
            printf "%s (y/n): " "$question"
        fi
        
        read answer
        
        # å¦‚æœæœ‰é»˜è®¤å€¼ä¸”ç”¨æˆ·ç›´æ¥å›è½¦
        if [ -z "$answer" ] && [ -n "$default" ]; then
            answer=$default
        fi
        
        case "$answer" in
            [Yy]|[Yy][Ee][Ss]) return 0 ;;
            [Nn]|[Nn][Oo]) return 1 ;;
            *) echo "è¯·è¾“å…¥ y æˆ– n" ;;
        esac
    done
}

# å¯ç”¨QoSåŠŸèƒ½
start_qos() {
    load_config
    
    # æ£€æŸ¥æ¥å£æ˜¯å¦å­˜åœ¨
    if ! ip link show "$WAN_IF" >/dev/null 2>&1; then
        print_status "error" "ç½‘ç»œæ¥å£ '$WAN_IF' ä¸å­˜åœ¨"
        echo ""
        print_section "å½“å‰å¯ç”¨çš„ç½‘ç»œæ¥å£"
        detect_interfaces
        echo ""
        print_status "info" "è¯·ä½¿ç”¨ '$0 reconfig' é‡æ–°é…ç½®æ­£ç¡®çš„æ¥å£"
        exit 1
    fi
    
    print_status "info" "å¯ç”¨fq_codel QoS: $WAN_IF ä¸Šä¼ ${UPLOAD_KBPS}kbps ä¸‹è½½${DOWNLOAD_KBPS}kbps"

    # æ¸…ç†ç°æœ‰é…ç½®
    tc qdisc del dev $WAN_IF root 2>/dev/null
    tc qdisc del dev $WAN_IF ingress 2>/dev/null
    tc qdisc del dev ifb0 root 2>/dev/null
    ip link del ifb0 2>/dev/null

    # é…ç½®ä¸Šä¼ é˜Ÿåˆ— - ä½å»¶è¿Ÿæ¸¸æˆä¼˜åŒ–
    tc qdisc add dev $WAN_IF root handle 1: tbf rate ${UPLOAD_KBPS}kbit latency 80ms burst 40k
    tc qdisc add dev $WAN_IF parent 1: fq_codel target 2ms interval 50ms flows 1024 quantum 300 ecn

    # é…ç½®ä¸‹è½½é˜Ÿåˆ— - æ¸¸æˆä¼˜å…ˆä½å»¶è¿Ÿ
    modprobe ifb
    ip link add name ifb0 type ifb 2>/dev/null
    ip link set dev ifb0 up
    tc qdisc add dev $WAN_IF ingress
    tc filter add dev $WAN_IF parent ffff: protocol all u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0
    tc qdisc add dev ifb0 root handle 1: tbf rate ${DOWNLOAD_KBPS}kbit latency 80ms burst 50k
    tc qdisc add dev ifb0 parent 1: fq_codel target 2ms interval 50ms flows 1024 quantum 300 ecn

    print_status "success" "QoSé…ç½®å®Œæˆ"
}

# åœæ­¢QoSåŠŸèƒ½
stop_qos() {
    load_config
    
    print_status "info" "æ­£åœ¨åœæ­¢QoS..."
    tc qdisc del dev $WAN_IF root 2>/dev/null
    tc qdisc del dev $WAN_IF ingress 2>/dev/null
    tc qdisc del dev ifb0 root 2>/dev/null
    ip link del ifb0 2>/dev/null
    print_status "success" "QoSå·²åœæ­¢"
}

# é‡ç½®ç»Ÿè®¡æ•°æ®
reset_stats() {
    load_config
    
    print_status "info" "æ­£åœ¨é‡ç½®QoSç»Ÿè®¡æ•°æ®..."
    
    # æ£€æŸ¥ç°æœ‰é…ç½®
    if tc qdisc show dev $WAN_IF | grep -q "qdisc tbf" && ip link show ifb0 >/dev/null 2>&1; then
        print_status "info" "æ£€æµ‹åˆ°ç°æœ‰é…ç½®ï¼Œé‡æ–°åº”ç”¨ä»¥æ¸…é™¤ç»Ÿè®¡æ•°æ®..."
        stop_qos
        sleep 1
        start_qos
        print_status "success" "ç»Ÿè®¡æ•°æ®å·²é‡ç½®"
    else
        print_status "warning" "æœªæ£€æµ‹åˆ°QoSé…ç½®ï¼Œæ— éœ€é‡ç½®"
    fi
}

# æ¸…å±å‡½æ•°
clear_screen() {
    printf '\033[2J\033[H'
}

# æ ¼å¼åŒ–å­—èŠ‚æ•°ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼Œä¸ä¾èµ–bcï¼‰
format_bytes() {
    local bytes=$1
    
    if [ $bytes -gt 1073741824 ]; then
        # GBè®¡ç®—
        local gb=$((bytes / 1073741824))
        local remainder=$((bytes % 1073741824))
        local decimal=$((remainder * 100 / 1073741824))
        printf "%d.%02dGB" $gb $decimal
    elif [ $bytes -gt 1048576 ]; then
        # MBè®¡ç®—
        local mb=$((bytes / 1048576))
        local remainder=$((bytes % 1048576))
        local decimal=$((remainder * 100 / 1048576))
        printf "%d.%02dMB" $mb $decimal
    elif [ $bytes -gt 1024 ]; then
        # KBè®¡ç®—
        local kb=$((bytes / 1024))
        local remainder=$((bytes % 1024))
        local decimal=$((remainder * 100 / 1024))
        printf "%d.%02dKB" $kb $decimal
    else
        printf "%dB" $bytes
    fi
}

# æ ¼å¼åŒ–é€Ÿç‡
format_rate() {
    local rate=$1
    if echo "$rate" | grep -q "Mbit"; then
        echo "$rate" | sed 's/Mbit/Mbps/'
    elif echo "$rate" | grep -q "Kbit"; then
        echo "$rate" | sed 's/Kbit/Kbps/'
    else
        echo "$rate"
    fi
}

# è·å–æ¸¸æˆé˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯
get_game_queue_stats() {
    local interface=$1
    local direction=$2
    
    # è·å–é˜Ÿåˆ—ç»Ÿè®¡
    local fq_stats=$(tc -s qdisc show dev $interface | grep -A 5 "qdisc fq_codel")
    local tbf_stats=$(tc -s qdisc show dev $interface | grep -A 3 "qdisc tbf")
    
    if [ -z "$fq_stats" ]; then
        print_status "error" "æœªæ‰¾åˆ° $direction fq_codelé˜Ÿåˆ—é…ç½®"
        return
    fi
    
    # æå–å…³é”®æ•°æ®
    local rate=$(echo "$tbf_stats" | grep "qdisc tbf" | grep -o "rate [^ ]*" | cut -d' ' -f2)
    local sent_bytes=$(echo "$fq_stats" | grep "Sent" | grep -o "Sent [0-9]*" | cut -d' ' -f2)
    local sent_packets=$(echo "$fq_stats" | grep "Sent" | grep -o "Sent [0-9]* bytes [0-9]*" | awk '{print $4}')
    local dropped=$(echo "$fq_stats" | grep "dropped" | grep -o "dropped [0-9]*" | cut -d' ' -f2)
    local old_flows=$(echo "$fq_stats" | grep "old_flows" | grep -o "old_flows [0-9]*" | cut -d' ' -f2)
    local new_flows=$(echo "$fq_stats" | grep "new_flows" | grep -o "new_flows [0-9]*" | cut -d' ' -f2)
    
    # é»˜è®¤å€¼å¤„ç†
    sent_bytes=${sent_bytes:-0}
    sent_packets=${sent_packets:-0}
    dropped=${dropped:-0}
    old_flows=${old_flows:-0}
    new_flows=${new_flows:-0}
    
    # è®¡ç®—ä¸¢åŒ…ç‡ (ç™¾åˆ†æ¯”)
    local drop_rate=0
    if [ $sent_packets -gt 0 ] && [ $dropped -gt 0 ]; then
        drop_rate=$(( (dropped * 10000) / (sent_packets + dropped) ))  # ç™¾åˆ†æ¯”*100
    fi
    
    # æ¸¸æˆæ€§èƒ½çŠ¶æ€åˆ¤æ–­
    local game_status=""
    local status_color=""
    local drop_rate_display=""
    
    if [ "$direction" = "ä¸Šä¼ " ]; then
        # ä¸Šä¼ ï¼šä»»ä½•ä¸¢åŒ…éƒ½æ˜¯é—®é¢˜ï¼Œç›´æ¥çœ‹ç»å¯¹æ•°é‡
        if [ $dropped -gt 50 ]; then
            game_status="âŒ å¯èƒ½å¡é¡¿"
            status_color="$RED"
        elif [ $dropped -gt 10 ]; then
            game_status="âš ï¸  å¶æœ‰å»¶è¿Ÿ"
            status_color="$YELLOW"
        else
            game_status="âœ… æµç•…"
            status_color="$GREEN"
        fi
        drop_rate_display="ç´¯è®¡: $dropped"
    else
        # ä¸‹è½½ï¼šå…³æ³¨ä¸¢åŒ…ç‡ï¼Œé€‚åº¦ä¸¢åŒ…è¯´æ˜QoSåœ¨å·¥ä½œ
        if [ $drop_rate -eq 0 ]; then
            game_status="âš ï¸  æµæ§æœªæ¿€æ´»"
            status_color="$YELLOW"
            drop_rate_display="ä¸¢åŒ…ç‡: 0%"
        elif [ $drop_rate -lt 100 ]; then  # <1%
            game_status="âœ… è½»åº¦æµæ§"
            status_color="$GREEN"
            drop_rate_display=$(printf "ä¸¢åŒ…ç‡: 0.%02d%%" $drop_rate)
        elif [ $drop_rate -lt 500 ]; then  # 1-5%
            game_status="âœ… ç§¯ææµæ§"
            status_color="$GREEN"
            drop_rate_display=$(printf "ä¸¢åŒ…ç‡: %d.%02d%%" $((drop_rate/100)) $((drop_rate%100)))
        elif [ $drop_rate -lt 1000 ]; then  # 5-10%
            game_status="âš ï¸  é‡åº¦æµæ§"
            status_color="$YELLOW"
            drop_rate_display=$(printf "ä¸¢åŒ…ç‡: %d.%02d%%" $((drop_rate/100)) $((drop_rate%100)))
        else  # >10%
            game_status="âŒ è¿‡åº¦ä¸¢åŒ…"
            status_color="$RED"
            drop_rate_display=$(printf "ä¸¢åŒ…ç‡: %d.%02d%%" $((drop_rate/100)) $((drop_rate%100)))
        fi
    fi
    
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "${PURPLE}  ğŸ® %sæ¸¸æˆé˜Ÿåˆ—${NC}\n" "$direction"
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "  å¸¦å®½: ${YELLOW}%s${NC} | æ€»æµé‡: ${GREEN}%s${NC}\n" "$(format_rate $rate)" "$(format_bytes $sent_bytes)"
    
    if [ "$direction" = "ä¸‹è½½" ]; then
        printf "  ${CYAN}%s${NC}\n" "$drop_rate_display"
    else
        printf "  ä¸¢åŒ…: ${RED}%s${NC}\n" "$drop_rate_display"
    fi
    
    printf "  æ¸¸æˆçŠ¶æ€: ${status_color}%s${NC}\n" "$game_status"
    printf "\n"
}

# æ˜¾ç¤ºç›‘æ§çŠ¶æ€è¯´æ˜
show_monitor_legend() {
    printf "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    printf "  ${GREEN}âœ… æµç•…/æµæ§${NC} | ${YELLOW}âš ï¸ æ³¨æ„${NC} | ${RED}âŒ é—®é¢˜${NC}\n"
    printf "  ${CYAN}ğŸ’¡ ä¸‹è½½ä¸¢åŒ…ç‡1-5%% = QoSä¼˜å…ˆä¿éšœæ¸¸æˆ${NC}\n"
    printf "  ${YELLOW}æŒ‰ Ctrl+C é€€å‡ºç›‘æ§${NC}\n"
}

# æ£€æŸ¥QoSçŠ¶æ€
check_qos_status() {
    if ! tc qdisc show dev $WAN_IF | grep -q "qdisc fq_codel"; then
        print_status "error" "æ¸¸æˆé˜Ÿåˆ—æœªå¯ç”¨"
        print_status "warning" "è¯·å…ˆè¿è¡Œ $0 start å¯ç”¨QoS"
        exit 1
    fi
}

# æ¸¸æˆé˜Ÿåˆ—ç›‘æ§å¾ªç¯
main_monitor() {
    load_config
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®ç»Ÿè®¡æ•°æ®
    if [ "$2" = "reset" ] || [ "$2" = "clean" ]; then
        print_status "info" "å‡†å¤‡å¼€å§‹æ¸¸æˆé˜Ÿåˆ—ç›‘æ§ï¼Œæ­£åœ¨é‡ç½®ç»Ÿè®¡æ•°æ®..."
        reset_stats
        sleep 2
    else
        print_status "info" "ğŸ® å¯åŠ¨æ¸¸æˆé˜Ÿåˆ—ç›‘æ§..."
        sleep 1
    fi
    
    while true; do
        clear_screen
        
        printf "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}\n"
        printf "${GREEN}â•‘                   ğŸ® æ¸¸æˆé˜Ÿåˆ—ç›‘æ§                             â•‘${NC}\n"
        printf "${GREEN}â•‘                   $(date '+%Y-%m-%d %H:%M:%S')                  â•‘${NC}\n"
        printf "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n\n"
        
        # æ£€æŸ¥QoSçŠ¶æ€
        check_qos_status
        
        # æ˜¾ç¤ºæ¸¸æˆé˜Ÿåˆ—ç»Ÿè®¡
        get_game_queue_stats $WAN_IF "ä¸Šä¼ "
        
        if ip link show ifb0 >/dev/null 2>&1; then
            get_game_queue_stats ifb0 "ä¸‹è½½"
        else
            print_status "error" "ä¸‹è½½æ¸¸æˆé˜Ÿåˆ—æœªé…ç½®"
            echo ""
        fi
        
        # æ˜¾ç¤ºçŠ¶æ€è¯´æ˜
        show_monitor_legend
        
        sleep 3
    done
}

# é‡æ–°é…ç½®ç½‘ç»œé€Ÿåº¦
reconfig_speed() {
    print_header "é‡æ–°é…ç½®QoSå‚æ•°"
    
    # æ˜¾ç¤ºå½“å‰é…ç½®
    if [ -f "$CONFIG_FILE" ]; then
        load_config
        print_section "å½“å‰é…ç½®"
        printf "  ç½‘ç»œæ¥å£: ${CYAN}%s${NC}\n" "$WAN_IF"
        printf "  ä¸Šä¼ é€Ÿåº¦: ${CYAN}%s Mbps${NC}\n" "$UPLOAD_MBPS"
        printf "  ä¸‹è½½é€Ÿåº¦: ${CYAN}%s Mbps${NC}\n" "$DOWNLOAD_MBPS"
        echo ""
    fi
    
    setup_config
    
    # å¦‚æœQoSæ­£åœ¨è¿è¡Œï¼Œé‡å¯ä»¥åº”ç”¨æ–°é…ç½®
    if tc qdisc show dev $WAN_IF | grep -q "qdisc tbf" 2>/dev/null; then
        echo ""
        print_status "info" "æ£€æµ‹åˆ°QoSæ­£åœ¨è¿è¡Œï¼Œæ­£åœ¨é‡å¯ä»¥åº”ç”¨æ–°é…ç½®..."
        stop_qos
        sleep 1
        start_qos
    fi
}

# æ˜¾ç¤ºå½“å‰é…ç½®
show_config() {
    if [ -f "$CONFIG_FILE" ]; then
        load_config
        print_header "å½“å‰QoSé…ç½®"
        
        printf "é…ç½®æ–‡ä»¶: ${CYAN}%s${NC}\n" "$CONFIG_FILE"
        printf "ç½‘ç»œæ¥å£: ${CYAN}%s${NC}\n" "$WAN_IF"
        printf "ä¸Šä¼ é€Ÿåº¦: ${CYAN}%s Mbps${NC} (é™é€Ÿ: ${YELLOW}%s Kbps${NC})\n" "$UPLOAD_MBPS" "$UPLOAD_KBPS"
        printf "ä¸‹è½½é€Ÿåº¦: ${CYAN}%s Mbps${NC} (é™é€Ÿ: ${YELLOW}%s Kbps${NC})\n" "$DOWNLOAD_MBPS" "$DOWNLOAD_KBPS"
        
        if [ "$APPLY_SYSCTL" = "yes" ]; then
            print_status "success" "å†…æ ¸ä¼˜åŒ–å·²åº”ç”¨"
        else
            print_status "warning" "å†…æ ¸ä¼˜åŒ–æœªåº”ç”¨"
        fi
        
        if [ -n "$CONFIG_CREATED" ]; then
            printf "åˆ›å»ºæ—¶é—´: ${PURPLE}%s${NC}\n" "$CONFIG_CREATED"
        fi
    else
        print_status "error" "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
        print_status "info" "è¯·å…ˆè¿è¡Œ '$0 start' è¿›è¡Œåˆå§‹é…ç½®"
    fi
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    print_header "OpenWrt fq_codel QoS æ¸¸æˆä¼˜åŒ–è„šæœ¬"
    
    printf "${BOLD}ç”¨æ³•:${NC} %s [å‘½ä»¤]\n\n" "$0"
    
    print_section "åŸºæœ¬å‘½ä»¤"
    printf "  ${GREEN}start${NC}        - å¯ç”¨QoS\n"
    printf "  ${GREEN}stop${NC}         - åœæ­¢QoS\n"
    printf "  ${GREEN}restart${NC}      - é‡å¯QoS\n\n"
    
    print_section "ğŸ® æ¸¸æˆç›‘æ§"
    printf "  ${GREEN}monitor${NC}      - æ¸¸æˆé˜Ÿåˆ—å®æ—¶ç›‘æ§\n"
    printf "  ${GREEN}monitor reset${NC}- é‡ç½®æ•°æ®åç›‘æ§\n\n"
    
    print_section "é…ç½®ç®¡ç†"
    printf "  ${GREEN}config${NC}       - æ˜¾ç¤ºå½“å‰é…ç½®\n"
    printf "  ${GREEN}reconfig${NC}     - é‡æ–°é…ç½®ç½‘é€Ÿå’Œæ¥å£\n"
    printf "  ${GREEN}reset${NC}        - é‡ç½®ç»Ÿè®¡æ•°æ®\n"
    printf "  ${GREEN}sysctl${NC}       - åº”ç”¨ç½‘ç»œå†…æ ¸ä¼˜åŒ–å‚æ•°\n\n"
    
    print_section "ç¤ºä¾‹"
    printf "  ${CYAN}%s start${NC}     - å¯ç”¨æ¸¸æˆä¼˜åŒ–QoS\n" "$0"
    printf "  ${CYAN}%s monitor${NC}   - ğŸ® å®æ—¶ç›‘æ§æ¸¸æˆé˜Ÿåˆ—\n" "$0"
}

# å‚æ•°å¤„ç†
case "$1" in
    "start")
        start_qos
        echo ""
        print_section "ğŸ® æ¸¸æˆä¼˜åŒ–å‘½ä»¤"
        print_status "info" "æ¸¸æˆé˜Ÿåˆ—ç›‘æ§: $0 monitor"
        print_status "info" "åœæ­¢QoS:      $0 stop"
        print_status "info" "æŸ¥çœ‹é…ç½®:     $0 config"
        ;;
    "stop")
        stop_qos
        ;;
    "restart")
        stop_qos
        print_status "info" "ç­‰å¾…1ç§’..."
        sleep 1
        start_qos
        ;;
    "monitor")
        main_monitor "$@"
        ;;
    "reset")
        reset_stats
        ;;
    "config")
        show_config
        ;;
    "reconfig")
        reconfig_speed
        ;;
    "sysctl")
        print_status "info" "æ­£åœ¨åº”ç”¨æ¨èçš„ç½‘ç»œå†…æ ¸ä¼˜åŒ–å‚æ•°..."
        APPLY_SYSCTL="yes"
        apply_sysctl_optimizations
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        print_status "error" "æœªçŸ¥å‘½ä»¤: $1"
        print_status "info" "ä½¿ç”¨ '$0 help' æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
        exit 1
        ;;
esac
